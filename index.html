<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysRevPlotter - Scientific Plotting Tool for Physics Journals</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            padding-bottom: 40px;
        }
        
        .header {
            background-color: #1f3d7a;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .main-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .plot-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            background-color: white;
        }
        
        .btn-primary {
            background-color: #1f3d7a;
            border-color: #1f3d7a;
        }
        
        .btn-primary:hover {
            background-color: #18305f;
            border-color: #18305f;
        }
        
        .color-sample {
            display: inline-block;
            width: 30px;
            height: 30px;
            margin-right: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .color-sample:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        
        .color-sample.active {
            transform: scale(1.15);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid #333;
        }
        
        /* High-quality journal color scheme */
        .prc-blue { background-color: #0C4B8E; }
        .prc-red { background-color: #BF2026; }
        .prc-green { background-color: #007046; }
        .prc-purple { background-color: #7D3C98; }
        .prc-orange { background-color: #E74C3C; }
        .prc-teal { background-color: #138D75; }
        .prc-brown { background-color: #873600; }
        .prc-dark-blue { background-color: #1A5276; }
        
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: none;
            margin: 10px 0;
        }
        
        .control-panel {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .control-panel h5 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #1f3d7a;
        }
        
        .dataset-item {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .footer {
            margin-top: 30px;
            padding: 20px 0;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
        }
        
        .line-edit-panel {
            border-left: 4px solid #1f3d7a;
            padding-left: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header text-center">
        <h1>PhysRevPlotter</h1>
        <p class="lead">Scientific plotting tool designed for physics journal papers</p>
    </header>

    <div class="container">
        <!-- Data Upload Area -->
        <div class="main-container">
            <h4>Data Upload</h4>
            <div class="mb-3">
                <label for="dataFile" class="form-label">Select data file</label>
                <input class="form-control" type="file" id="dataFile" accept=".csv,.txt,.dat">
                <div class="form-text">Supports CSV, TXT, and DAT file formats</div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Data Delimiter</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="delimiter" id="delimiterComma" value="," checked>
                        <label class="form-check-label" for="delimiterComma">Comma (,)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="delimiter" id="delimiterSpace" value=" ">
                        <label class="form-check-label" for="delimiterSpace">Space</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="delimiter" id="delimiterTab" value="\t">
                        <label class="form-check-label" for="delimiterTab">Tab</label>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <label class="form-label">Preview</label>
                    <textarea class="form-control" id="dataPreview" rows="4" readonly></textarea>
                </div>
            </div>
            
            <button class="btn btn-primary" id="loadDataBtn">Load Data</button>
            <div class="loading" id="loading">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Processing data...</span>
            </div>
            <div id="status" class="status-message"></div>
        </div>

        <div class="row">
            <!-- Plot Area -->
            <div class="col-lg-8">
                <div class="main-container">
                    <h4>Plot Area</h4>
                    <div id="plotContainer" class="plot-container"></div>
                    
                    <div class="row">
                        <div class="col-md-12 text-end">
                            <button class="btn btn-sm btn-outline-secondary me-2" id="resetZoomBtn">Reset Zoom</button>
                            <button class="btn btn-sm btn-outline-primary me-2" id="saveAsPNGBtn">Export PNG</button>
                            <button class="btn btn-sm btn-outline-primary" id="saveAsSVGBtn">Export SVG</button>
                        </div>
                    </div>
                </div>
                
                <!-- Dataset Listing -->
                <div class="main-container">
                    <h4>Datasets</h4>
                    <div id="datasetsList">
                        <p class="text-muted">No data loaded yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Plot Controls -->
            <div class="col-lg-4">
                <!-- Line Editing Panel -->
                <div class="main-container">
                    <h4>Dataset Styling</h4>
                    <div class="line-edit-panel">
                        <div class="mb-3">
                            <label for="datasetSelector" class="form-label">Select Dataset to Style</label>
                            <select class="form-select" id="datasetSelector">
                                <option value="">-- No datasets plotted --</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="datasetLabel" class="form-label">Dataset Label</label>
                            <input type="text" class="form-control" id="datasetLabel" placeholder="Enter dataset label">
                            <small class="form-text text-muted">This label will appear in the legend</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Color Selection</label>
                            <div class="d-flex flex-wrap" id="colorSelector">
                                <span class="color-sample prc-blue" data-color="#0C4B8E" style="cursor:pointer; margin-bottom:5px;"></span>
                                <span class="color-sample prc-red" data-color="#BF2026" style="cursor:pointer; margin-bottom:5px;"></span>
                                <span class="color-sample prc-green" data-color="#007046" style="cursor:pointer; margin-bottom:5px;"></span>
                                <span class="color-sample prc-purple" data-color="#7D3C98" style="cursor:pointer; margin-bottom:5px;"></span>
                                <span class="color-sample prc-orange" data-color="#E74C3C" style="cursor:pointer; margin-bottom:5px;"></span>
                                <span class="color-sample prc-teal" data-color="#138D75" style="cursor:pointer; margin-bottom:5px;"></span>
                                <span class="color-sample prc-brown" data-color="#873600" style="cursor:pointer; margin-bottom:5px;"></span>
                                <span class="color-sample prc-dark-blue" data-color="#1A5276" style="cursor:pointer; margin-bottom:5px;"></span>
                            </div>
                            <div class="mt-2">
                                <div class="form-text">Selected color: <span id="currentColor" style="font-weight:bold;">#0C4B8E</span></div>
                                <input type="color" id="customColor" class="form-control form-control-sm mt-1" value="#0C4B8E">
                                <div class="form-text">Or use custom color</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="lineWidth" class="form-label">Line Width</label>
                                    <input type="range" class="form-range" min="1" max="5" step="0.5" value="2" id="lineWidth">
                                    <div class="text-center"><span id="lineWidthValue">2</span></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="lineStyle" class="form-label">Line Style</label>
                                    <select class="form-select" id="lineStyle">
                                        <option value="solid">Solid</option>
                                        <option value="dash">Dashed</option>
                                        <option value="dot">Dotted</option>
                                        <option value="dashdot">Dash-Dot</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="markerSize" class="form-label">Marker Size</label>
                                    <input type="range" class="form-range" min="2" max="12" step="1" value="7" id="markerSize">
                                    <div class="text-center"><span id="markerSizeValue">7</span></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="markerStyle" class="form-label">Marker Style</label>
                                    <select class="form-select" id="markerStyle">
                                        <option value="circle">Circle</option>
                                        <option value="square">Square</option>
                                        <option value="diamond">Diamond</option>
                                        <option value="triangle-up">Triangle</option>
                                        <option value="star">Star</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="autoApply" checked>
                            <label class="form-check-label" for="autoApply">Auto-apply changes</label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="applyStylesBtn">Apply Style to Selected Dataset</button>
                            <button class="btn btn-outline-danger" id="removeDatasetBtn">Remove Selected Dataset</button>
                        </div>
                    </div>
                </div>
                
                <!-- Basic Chart Controls -->
                <div class="main-container">
                    <h4>Chart Settings</h4>
                    <div class="control-panel">
                        <div class="mb-3">
                            <label for="plotTitle" class="form-label">Chart Title</label>
                            <input type="text" class="form-control" id="plotTitle" placeholder="Enter chart title">
                        </div>
                        <div class="mb-3">
                            <label for="xAxisLabel" class="form-label">X-Axis Label</label>
                            <input type="text" class="form-control" id="xAxisLabel" placeholder="X-axis label">
                        </div>
                        <div class="mb-3">
                            <label for="yAxisLabel" class="form-label">Y-Axis Label</label>
                            <input type="text" class="form-control" id="yAxisLabel" placeholder="Y-axis label">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="showLegend" checked>
                            <label class="form-check-label" for="showLegend">Show Legend</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="showBorder" checked>
                            <label class="form-check-label" for="showBorder">Show Border on All Sides</label>
                        </div>
                        <button id="applyBasicSettingsBtn" class="btn btn-primary w-100">Apply Chart Settings</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer with attribution -->
        <div class="footer">
            <p>Designed and made by <a href="http://jinlei.fewbody.com/">Jin Lei</a>. Supported by the National Natural Science Foundation of China (Grants No. 12475132). If you find any bugs or errors related to this website, please <a href="mailto:jinl@tongji.edu.cn">email me</a>.</p>
        </div>
    </div>

    <!-- Required JavaScript libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.20.0/dist/plotly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

    <script>
        // Global variables
        const app = {
            datasets: {}, // Store raw datasets
            plotData: {}, // Store plotted datasets and their styles
            activePlot: [], // Currently displayed traces on the plot
            nextColorIndex: 0, // Index for assigning colors to new datasets
            selectedDataset: null, // Currently selected dataset for styling
            colors: [
                '#0C4B8E', // Blue
                '#BF2026', // Red
                '#007046', // Green
                '#7D3C98', // Purple
                '#E74C3C', // Orange
                '#138D75', // Teal
                '#873600', // Brown
                '#1A5276'  // Dark Blue
            ]
        };
        
        // Add event listeners for style controls
        function addStyleControlListeners() {
            // Add event listeners for real-time preview (without immediate apply)
            document.getElementById('markerSize').addEventListener('input', function() {
                document.getElementById('markerSizeValue').textContent = this.value;
            });
            
            document.getElementById('lineWidth').addEventListener('input', function() {
                document.getElementById('lineWidthValue').textContent = this.value;
            });
            
            document.getElementById('customColor').addEventListener('input', function() {
                const color = this.value;
                document.getElementById('currentColor').textContent = color;
                
                // Deselect all color samples
                document.querySelectorAll('#colorSelector .color-sample').forEach(s => {
                    s.classList.remove('active');
                });
            });
            
            // Apply styles when controls change
            document.getElementById('lineStyle').addEventListener('change', function() {
                if (document.getElementById('autoApply').checked) {
                    applyStylesImmediately();
                }
            });
            
            document.getElementById('markerStyle').addEventListener('change', function() {
                if (document.getElementById('autoApply').checked) {
                    applyStylesImmediately();
                }
            });
            
            document.getElementById('markerSize').addEventListener('change', function() {
                if (document.getElementById('autoApply').checked) {
                    applyStylesImmediately();
                }
            });
            
            document.getElementById('lineWidth').addEventListener('change', function() {
                if (document.getElementById('autoApply').checked) {
                    applyStylesImmediately();
                }
            });
            
            document.getElementById('customColor').addEventListener('change', function() {
                if (document.getElementById('autoApply').checked) {
                    applyStylesImmediately();
                }
            });
            
            document.getElementById('datasetLabel').addEventListener('change', function() {
                if (document.getElementById('autoApply').checked) {
                    applyStylesImmediately();
                }
            });
        }
        
        // Display status message
        function showStatus(message, isError = false) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            
            if (isError) {
                statusElement.className = 'status-message status-error';
            } else {
                statusElement.className = 'status-message status-success';
            }
        }
        
        // Show/hide loading indicator
        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        // Initialize plot
        function initPlot() {
            const plotContainer = document.getElementById('plotContainer');
            
            const layout = {
                autosize: true,
                title: '',
                font: {
                    family: 'Arial, Helvetica, sans-serif',
                    size: 14,
                    color: '#333'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                xaxis: {
                    title: '',
                    showgrid: true,
                    zeroline: true,
                    showline: true, // Show x-axis line
                    mirror: 'all',  // Show borders on all sides
                    linecolor: '#333',
                    gridcolor: '#ddd',
                    zerolinecolor: '#333',
                    linewidth: 1,
                    automargin: true
                },
                yaxis: {
                    title: '',
                    showgrid: true,
                    zeroline: true,
                    showline: true, // Show y-axis line
                    mirror: 'all',  // Show borders on all sides
                    linecolor: '#333',
                    gridcolor: '#ddd',
                    zerolinecolor: '#333',
                    linewidth: 1,
                    automargin: true
                },
                margin: {
                    l: 60,
                    r: 40,
                    t: 60,
                    b: 60
                },
                showlegend: true,
                legend: {
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: '#ddd',
                    borderwidth: 1
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displaylogo: false
            };
            
            Plotly.newPlot(plotContainer, [], layout, config);
        }
        
        // Load data
        function loadData() {
            const fileInput = document.getElementById('dataFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a data file first', true);
                return;
            }
            
            // Get selected delimiter
            let delimiter = null;
            const delimiterRadios = document.getElementsByName('delimiter');
            for (let i = 0; i < delimiterRadios.length; i++) {
                if (delimiterRadios[i].checked) {
                    delimiter = delimiterRadios[i].value;
                    break;
                }
            }
            
            toggleLoading(true);
            showStatus('');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // Show data preview
                    document.getElementById('dataPreview').value = content.substring(0, 500) + 
                        (content.length > 500 ? '...' : '');
                    
                    // Parse data
                    const parseOptions = {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        delimiter: delimiter,
                        complete: function(results) {
                            if (results.errors && results.errors.length > 0) {
                                console.warn('Data parsing warnings:', results.errors);
                                
                                // Notify user of warnings
                                if (results.errors.length > 0) {
                                    const warningMsg = `Parsed with ${results.errors.length} warning(s). Data may be incomplete.`;
                                    showStatus(warningMsg, false);
                                }
                            }
                            
                            if (!results.data || results.data.length === 0) {
                                showStatus('No valid data rows after parsing', true);
                                toggleLoading(false);
                                return;
                            }
                            
                            // Data preprocessing - clean column names
                            const cleanData = results.data.filter(row => Object.keys(row).length > 0).map(row => {
                                const cleanRow = {};
                                for (const key in row) {
                                    if (key === null || key === undefined || key.trim() === '') continue; // Skip empty column names
                                    cleanRow[key.trim()] = row[key];
                                }
                                return cleanRow;
                            });
                            
                            if (cleanData.length === 0) {
                                showStatus('No valid data rows after cleaning', true);
                                toggleLoading(false);
                                return;
                            }
                            
                            // Add to datasets
                            const datasetName = file.name;
                            app.datasets[datasetName] = cleanData;
                            
                            // Update UI
                            updateDatasetsList();
                            
                            // Auto-plot data
                            addDatasetToPlot(datasetName);
                            
                            showStatus(`Successfully loaded file: ${file.name}, with ${cleanData.length} rows of data`);
                            toggleLoading(false);
                        },
                        error: function(error) {
                            console.error('Parsing error:', error);
                            showStatus('Data parsing error: ' + error.message, true);
                            toggleLoading(false);
                        }
                    };
                    
                    // Use PapaParse to parse the data
                    Papa.parse(content, parseOptions);
                    
                } catch (error) {
                    console.error('File reading error:', error);
                    showStatus('File reading error: ' + error.message, true);
                    toggleLoading(false);
                }
            };
            
            reader.onerror = function() {
                showStatus('File reading error', true);
                toggleLoading(false);
            };
            
            reader.readAsText(file);
        }
        
        // Update datasets list
        function updateDatasetsList() {
            const container = document.getElementById('datasetsList');
            container.innerHTML = '';
            
            if (Object.keys(app.datasets).length === 0) {
                container.innerHTML = '<p class="text-muted">No data loaded yet</p>';
                return;
            }
            
            for (const name in app.datasets) {
                const dataset = app.datasets[name];
                
                const datasetItem = document.createElement('div');
                datasetItem.className = 'dataset-item';
                
                const header = document.createElement('div');
                header.className = 'd-flex justify-content-between align-items-center mb-2';
                
                const title = document.createElement('strong');
                title.textContent = name;
                
                const controls = document.createElement('div');
                
                const plotBtn = document.createElement('button');
                plotBtn.className = 'btn btn-sm btn-outline-primary me-1';
                plotBtn.textContent = 'Plot';
                plotBtn.addEventListener('click', function() {
                    addDatasetToPlot(name);
                });
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', function() {
                    if (confirm(`Are you sure you want to remove dataset "${name}"?`)) {
                        delete app.datasets[name];
                        updateDatasetsList();
                    }
                });
                
                controls.appendChild(plotBtn);
                controls.appendChild(removeBtn);
                
                header.appendChild(title);
                header.appendChild(controls);
                
                const info = document.createElement('div');
                info.className = 'small text-muted';
                
                // Get column info
                const columnsInfo = dataset.length > 0 ? 
                    `Columns: ${Object.keys(dataset[0]).join(', ')}` : '';
                
                info.textContent = `${dataset.length} rows | ${columnsInfo}`;
                
                datasetItem.appendChild(header);
                datasetItem.appendChild(info);
                
                container.appendChild(datasetItem);
            }
        }
        
        // Add a dataset to the plot
        function addDatasetToPlot(name) {
            try {
                if (!app.datasets[name]) {
                    showStatus(`Dataset not found: ${name}`, true);
                    return;
                }
                
                const data = app.datasets[name];
                
                if (data.length === 0) {
                    showStatus('Dataset is empty', true);
                    return;
                }
                
                // Get column names
                const columns = Object.keys(data[0]);
                
                if (columns.length < 2) {
                    showStatus('Data must contain at least two columns', true);
                    return;
                }
                
                // Use first two columns as x and y
                const xColumn = columns[0];
                const yColumn = columns[1];
                
                // Extract valid data points
                const validData = data.filter(row => {
                    return row[xColumn] !== null && row[xColumn] !== undefined && 
                           row[yColumn] !== null && row[yColumn] !== undefined &&
                           !isNaN(row[xColumn]) && !isNaN(row[yColumn]);
                });
                
                if (validData.length === 0) {
                    showStatus('No valid data points found', true);
                    return;
                }
                
                const x = validData.map(row => row[xColumn]);
                const y = validData.map(row => row[yColumn]);
                
                // Choose a color from the color list
                const colorIndex = app.nextColorIndex % app.colors.length;
                app.nextColorIndex++;
                const selectedColor = app.colors[colorIndex];
                
                // Create trace settings
                const displayName = `${name} (${yColumn} vs ${xColumn})`;
                
                // Create plot data
                const trace = {
                    x: x,
                    y: y,
                    mode: 'lines+markers',
                    type: 'scatter',
                    name: displayName,
                    line: {
                        color: selectedColor,
                        width: 2,
                        dash: 'solid'
                    },
                    marker: {
                        color: selectedColor,
                        size: 7,
                        symbol: 'circle'
                    }
                };
                
                // Store the trace settings for this dataset
                app.plotData[name] = {
                    trace: trace,
                    columns: {
                        x: xColumn,
                        y: yColumn
                    },
                    style: {
                        color: selectedColor,
                        lineWidth: 2,
                        lineStyle: 'solid',
                        markerSize: 7,
                        markerStyle: 'circle'
                    }
                };
                
                // Update active plot data
                updatePlot();
                
                // Select this dataset in the style selector
                updateDatasetSelector();
                selectDataset(name);
                
                // Set title and axis labels if this is the first dataset
                if (Object.keys(app.plotData).length === 1) {
                    // Set default title and axis labels
                    document.getElementById('plotTitle').value = 'Data Visualization';
                    document.getElementById('xAxisLabel').value = xColumn;
                    document.getElementById('yAxisLabel').value = yColumn;
                    
                    // Apply settings
                    applyTitleAndAxisSettings();
                }
                
                showStatus(`Added dataset: ${name} to plot`);
            } catch (error) {
                console.error('Adding dataset error:', error);
                showStatus('Error adding dataset: ' + error.message, true);
            }
        }
        
        // Remove a dataset from the plot
        function removeDatasetFromPlot(name) {
            if (app.plotData[name]) {
                delete app.plotData[name];
                
                // Update the plot
                updatePlot();
                
                // Update the dataset selector
                updateDatasetSelector();
                
                showStatus(`Removed dataset: ${name} from plot`);
            }
        }
        
        // Update the whole plot with current data
        function updatePlot() {
            try {
                // Create array of traces from plotData
                const traces = Object.values(app.plotData).map(item => item.trace);
                app.activePlot = traces;
                
                // If there are no traces, create an empty plot
                if (traces.length === 0) {
                    Plotly.react('plotContainer', [], {
                        title: 'No Data',
                        xaxis: {
                            title: '',
                            showgrid: true,
                            zeroline: true,
                            showline: true,
                            mirror: 'all',
                            linecolor: '#333',
                            linewidth: 1
                        },
                        yaxis: {
                            title: '',
                            showgrid: true,
                            zeroline: true,
                            showline: true,
                            mirror: 'all',
                            linecolor: '#333',
                            linewidth: 1
                        }
                    });
                    return;
                }
                
                // Get current layout to preserve settings
                const plotDiv = document.getElementById('plotContainer');
                let currentLayout = plotDiv._fullLayout || {};
                
                // Create default layout if none exists
                const layout = {
                    title: currentLayout.title?.text || 'Data Visualization',
                    xaxis: {
                        title: currentLayout.xaxis?.title?.text || '',
                        showgrid: true,
                        zeroline: true,
                        showline: true,
                        mirror: 'all',
                        linecolor: '#333',
                        linewidth: 1
                    },
                    yaxis: {
                        title: currentLayout.yaxis?.title?.text || '',
                        showgrid: true,
                        zeroline: true,
                        showline: true,
                        mirror: 'all',
                        linecolor: '#333',
                        linewidth: 1
                    },
                    showlegend: true
                };
                
                // Update plot
                Plotly.react('plotContainer', traces, layout);
            } catch (error) {
                console.error('Plot update error:', error);
                showStatus('Error updating plot: ' + error.message, true);
            }
        }
        
        // Apply title and axis settings
        function applyTitleAndAxisSettings() {
            try {
                if (Object.keys(app.plotData).length === 0) {
                    showStatus('No data available for plotting', true);
                    return;
                }
                
                // Get settings
                const title = document.getElementById('plotTitle').value;
                const xAxisLabel = document.getElementById('xAxisLabel').value;
                const yAxisLabel = document.getElementById('yAxisLabel').value;
                const showLegend = document.getElementById('showLegend').checked;
                const showBorder = document.getElementById('showBorder').checked;
                
                // Update layout
                const layout = {
                    title: title,
                    showlegend: showLegend,
                    xaxis: {
                        title: xAxisLabel,
                        showline: showBorder,
                        mirror: showBorder ? 'all' : false
                    },
                    yaxis: {
                        title: yAxisLabel,
                        showline: showBorder,
                        mirror: showBorder ? 'all' : false
                    }
                };
                
                // Update plot
                Plotly.relayout('plotContainer', layout);
                
                showStatus('Applied title and axis settings');
            } catch (error) {
                console.error('Error applying title and axis settings:', error);
                showStatus('Error applying settings: ' + error.message, true);
            }
        }

        // Apply all plot settings
        function applySettings() {
            try {
                // Apply title and axis settings
                applyTitleAndAxisSettings();
                
                // Apply style settings to selected dataset
                applyStylesImmediately();
                
                showStatus('Applied all settings');
            } catch (error) {
                console.error('Error applying settings:', error);
                showStatus('Error applying settings: ' + error.message, true);
            }
        }
        
        // Reset zoom
        function resetZoom() {
            Plotly.relayout('plotContainer', {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
        }
        
        // Save plot as PNG
        function saveAsPNG() {
            Plotly.downloadImage('plotContainer', {
                format: 'png',
                width: 1200,
                height: 800,
                scale: 2,
                filename: 'phys_rev_plot'
            });
        }
        
        // Save plot as SVG
        function saveAsSVG() {
            Plotly.downloadImage('plotContainer', {
                format: 'svg',
                width: 1200,
                height: 800,
                filename: 'phys_rev_plot'
            });
        }
        
        // Update dataset selector dropdown
        function updateDatasetSelector() {
            const selector = document.getElementById('datasetSelector');
            selector.innerHTML = '';
            
            if (Object.keys(app.plotData).length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.text = '-- No datasets plotted --';
                selector.appendChild(option);
                
                // Disable the styling controls
                document.getElementById('datasetLabel').disabled = true;
                document.getElementById('lineWidth').disabled = true;
                document.getElementById('lineStyle').disabled = true;
                document.getElementById('markerSize').disabled = true;
                document.getElementById('markerStyle').disabled = true;
                document.getElementById('customColor').disabled = true;
                document.getElementById('applyStylesBtn').disabled = true;
                document.getElementById('removeDatasetBtn').disabled = true;
                document.getElementById('autoApply').disabled = true;
                
                return;
            }
            
            // Enable the styling controls
            document.getElementById('datasetLabel').disabled = false;
            document.getElementById('lineWidth').disabled = false;
            document.getElementById('lineStyle').disabled = false;
            document.getElementById('markerSize').disabled = false;
            document.getElementById('markerStyle').disabled = false;
            document.getElementById('customColor').disabled = false;
            document.getElementById('applyStylesBtn').disabled = false;
            document.getElementById('removeDatasetBtn').disabled = false;
            document.getElementById('autoApply').disabled = false;
            
            // Add options for each dataset
            for (const name in app.plotData) {
                const option = document.createElement('option');
                option.value = name;
                option.text = `${name} (${app.plotData[name].columns.y} vs ${app.plotData[name].columns.x})`;
                selector.appendChild(option);
            }
        }
        
        // Select a dataset for styling
        function selectDataset(name) {
            if (!app.plotData[name]) return;
            
            app.selectedDataset = name;
            const dataset = app.plotData[name];
            
            // Set form values from dataset style
            document.getElementById('datasetSelector').value = name;
            document.getElementById('datasetLabel').value = dataset.trace.name;
            document.getElementById('lineWidth').value = dataset.style.lineWidth;
            document.getElementById('lineWidthValue').textContent = dataset.style.lineWidth;
            document.getElementById('lineStyle').value = dataset.style.lineStyle;
            document.getElementById('markerSize').value = dataset.style.markerSize;
            document.getElementById('markerSizeValue').textContent = dataset.style.markerSize;
            document.getElementById('markerStyle').value = dataset.style.markerStyle;
            document.getElementById('currentColor').textContent = dataset.style.color;
            document.getElementById('customColor').value = dataset.style.color;
            
            // Highlight the color in the selector if it matches a predefined color
            document.querySelectorAll('#colorSelector .color-sample').forEach(sample => {
                sample.classList.remove('active');
                if (sample.getAttribute('data-color') === dataset.style.color) {
                    sample.classList.add('active');
                }
            });
        }
        
        // Apply style settings to the selected dataset
        function applyStylesImmediately() {
            const selectedDataset = app.selectedDataset;
            
            // If no dataset is selected, don't do anything
            if (!selectedDataset || !app.plotData[selectedDataset]) return;
            
            try {
                // Get current style settings
                const markerSize = parseInt(document.getElementById('markerSize').value);
                const lineWidth = parseFloat(document.getElementById('lineWidth').value);
                const lineStyle = document.getElementById('lineStyle').value;
                const markerStyle = document.getElementById('markerStyle').value;
                const currentColor = document.getElementById('currentColor').textContent;
                const datasetLabel = document.getElementById('datasetLabel').value.trim() || app.plotData[selectedDataset].trace.name;
                
                // Update dataset style
                app.plotData[selectedDataset].style = {
                    color: currentColor,
                    lineWidth: lineWidth,
                    lineStyle: lineStyle,
                    markerSize: markerSize,
                    markerStyle: markerStyle
                };
                
                // Update trace properties
                app.plotData[selectedDataset].trace.name = datasetLabel;
                app.plotData[selectedDataset].trace.line = {
                    color: currentColor,
                    width: lineWidth,
                    dash: lineStyle === 'solid' ? 'solid' : 
                          lineStyle === 'dash' ? 'dash' :
                          lineStyle === 'dot' ? 'dot' : 'dashdot'
                };
                app.plotData[selectedDataset].trace.marker = {
                    color: currentColor,
                    size: markerSize,
                    symbol: markerStyle
                };
                
                // Find the index of this trace in the active plot
                const traceIndex = app.activePlot.findIndex(trace => 
                    trace === app.plotData[selectedDataset].trace);
                
                if (traceIndex !== -1) {
                    // Apply style update to the plot
                    Plotly.restyle('plotContainer', {
                        'name': datasetLabel,
                        'line.color': currentColor,
                        'line.width': lineWidth,
                        'line.dash': lineStyle === 'solid' ? 'solid' : 
                                    lineStyle === 'dash' ? 'dash' :
                                    lineStyle === 'dot' ? 'dot' : 'dashdot',
                        'marker.color': currentColor,
                        'marker.size': markerSize,
                        'marker.symbol': markerStyle
                    }, [traceIndex]);
                } else {
                    // If we can't find the trace index, just update the whole plot
                    updatePlot();
                }
                
                // Update values display
                document.getElementById('markerSizeValue').textContent = markerSize;
                document.getElementById('lineWidthValue').textContent = lineWidth;
                
                showStatus(`Applied style to dataset: ${selectedDataset}`);
            } catch (error) {
                console.error('Style update error:', error);
                showStatus('Error updating style: ' + error.message, true);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize plot
            initPlot();
            
            // Add style control listeners
            addStyleControlListeners();
            
            // Bind events
            document.getElementById('loadDataBtn').addEventListener('click', loadData);
            document.getElementById('applyStylesBtn').addEventListener('click', applyStylesImmediately);
            document.getElementById('removeDatasetBtn').addEventListener('click', function() {
                const selectedDataset = app.selectedDataset;
                if (selectedDataset && confirm(`Are you sure you want to remove "${selectedDataset}" from the plot?`)) {
                    removeDatasetFromPlot(selectedDataset);
                }
            });
            
            document.getElementById('applyBasicSettingsBtn').addEventListener('click', function() {
                // Apply title, axis labels, legend and border settings
                applyTitleAndAxisSettings();
            });
            document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);
            document.getElementById('saveAsPNGBtn').addEventListener('click', saveAsPNG);
            document.getElementById('saveAsSVGBtn').addEventListener('click', saveAsSVG);
            
            // Dataset selector change
            document.getElementById('datasetSelector').addEventListener('change', function() {
                const selectedDataset = this.value;
                if (selectedDataset) {
                    selectDataset(selectedDataset);
                }
            });
            
            // Color selection
            document.querySelectorAll('#colorSelector .color-sample').forEach(sample => {
                sample.addEventListener('click', function() {
                    // Remove active state from all samples
                    document.querySelectorAll('#colorSelector .color-sample').forEach(s => {
                        s.classList.remove('active');
                    });
                    
                    // Add active state to current sample
                    this.classList.add('active');
                    
                    const color = this.getAttribute('data-color');
                    document.getElementById('currentColor').textContent = color;
                    document.getElementById('customColor').value = color;
                    
                    if (document.getElementById('autoApply').checked) {
                        applyStylesImmediately();
                    }
                });
            });
            
            // Default select first color
            document.querySelector('#colorSelector .color-sample').classList.add('active');
            
            // Disable styling controls initially (until a dataset is selected)
            document.getElementById('datasetLabel').disabled = true;
            document.getElementById('lineWidth').disabled = true;
            document.getElementById('lineStyle').disabled = true;
            document.getElementById('markerSize').disabled = true;
            document.getElementById('markerStyle').disabled = true;
            document.getElementById('customColor').disabled = true;
            document.getElementById('applyStylesBtn').disabled = true;
            document.getElementById('removeDatasetBtn').disabled = true;
            document.getElementById('autoApply').disabled = true;
            
            // File upload preview
            document.getElementById('dataFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('dataPreview').value = 
                        event.target.result.substring(0, 500) + 
                        (event.target.result.length > 500 ? '...' : '');
                    
                    // Auto-check the appropriate delimiter based on file extension
                    if (file.name.endsWith('.csv')) {
                        document.getElementById('delimiterComma').checked = true;
                    } else if (file.name.endsWith('.txt') || file.name.endsWith('.dat')) {
                        // Check first few lines for tabs or spaces
                        const content = event.target.result.substring(0, 500);
                        if (content.indexOf('\t') !== -1) {
                            document.getElementById('delimiterTab').checked = true;
                        } else if (content.indexOf(' ') !== -1) {
                            document.getElementById('delimiterSpace').checked = true;
                        }
                    }
                };
                reader.readAsText(file);
            });
            
            // Initialize value displays
            document.getElementById('markerSizeValue').textContent = document.getElementById('markerSize').value;
            document.getElementById('lineWidthValue').textContent = document.getElementById('lineWidth').value;
            
            // Initialize app data
            app.plotData = {};
            app.activePlot = [];
            app.nextColorIndex = 0;
            app.selectedDataset = null;
        });
    </script>
</body>
</html>